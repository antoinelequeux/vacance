<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Vote Elo - 10 Images</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
    h1, h2 { text-align: center; }
    .hidden { display: none; }
    .image-container { display: flex; justify-content: space-around; margin-top: 20px; }
    .option { width: 45%; text-align: center; }
    img { max-width: 100%; height: auto; border: 1px solid #ccc; margin-bottom: 5px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .results { margin: 20px 0; }
    .results li { margin-bottom: 5px; }
  </style>
</head>
<body>

<h1>Comparaison d'images (Elo)</h1>

<!-- √âcran 1 : entrer nom + d√©marrer -->
<div id="startScreen">
  <p>Entrez votre nom : <input type="text" id="playerName" placeholder="Ex: Alice"></p>
  <button onclick="startVoting()">Commencer</button>
</div>

<!-- √âcran 2 : duels -->
<div id="duelScreen" class="hidden">
  <h2>Votez sur votre image pr√©f√©r√©e</h2>
  <p>Il y aura 20 duels.</p>
  <div id="duelContainer" class="image-container">
    <div class="option">
      <img id="leftImg" src="" alt="">
      <div id="leftTitle"></div>
      <button onclick="choose('left')">Choisir cette image</button>
    </div>
    <div class="option">
      <img id="rightImg" src="" alt="">
      <div id="rightTitle"></div>
      <button onclick="choose('right')">Choisir cette image</button>
    </div>
  </div>
  <p id="progress"></p>
</div>

<!-- √âcran 3 : r√©sultats finaux -->
<div id="resultsScreen" class="hidden">
  <h2>Merci, vos votes ont √©t√© pris en compte !</h2>
  <div class="results">
    <h3>Classement (Elo) √† jour</h3>
    <ol id="finalRanking"></ol>
  </div>
</div>

<script>
// ================== CONFIG ====================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9KUfLh2XfA-ppzlbd4yba0Ch2IbVBh5fBHl07et3eBrLZ0CtGwpYZ9RZNVyby57x5/exec"; 
const NB_ITEMS = 10;  
const NB_DUELS = 20; // Nombre de duels par participant
const K_FACTOR = 32; // le m√™me que dans Apps Script

// Tes 10 images (chemin, titre, description √©ventuellement)
const items = [
  { index: 0, img: "Guyane/Kaw.jpeg",  title: "üêä Kaw ‚Äì Journ√©e + nuit au Camp Ca√Øman",  description: "Plonge au c≈ìur des marais de Kaw, entre ciel rose et brume myst√©rieuse. Croisi√®re au coucher du soleil, yeux qui brillent dans la nuit (coucou les ca√Ømans), et nuit magique au camp, en pleine nature (dans un lit). D√©connexion garantie.",  elo: 1000 },
  { index: 1, img: "Guyane/oiapoque.jpeg",  title: "üéâ Oiapoque ‚Äì F√™te + nuit chez Rona"   description: "Passe la fronti√®re pour une soir√©e br√©silienne comme tu les r√™ves : musique, danse, chaleur humaine. Et pour couronner le tout, nuit chez Rona, une ambiance locale, simple et authentique. T‚Äôen sortiras avec le sourire coll√© au visage",  elo: 1000 },
  { index: 2, img: "Guyane/CSG.jpeg",  title: "üöÄ Visite du CSG (Centre Spatial Guyanais)"   description: "Explore le c≈ìur de l‚Äôaventure spatiale europ√©enne. Fus√©es, technologie de pointe, √©toiles plein les yeux. C‚Äôest pas tous les jours qu‚Äôon peut marcher l√† o√π Ariane d√©colle !",  elo: 1000 },
  { index: 3, img: "Guyane/iledusalut.jpeg",  title: "üåä √éles du Salut ‚Äì Une journ√©e d‚Äô√©vasion historique"   description: "Embarque pour une travers√©e vers les mythiques √éles du Salut. Plages paradisiaques, ruines charg√©es d‚Äôhistoire et singes curieux‚Ä¶ Le combo parfait entre d√©tente, aventure et frissons du pass√©.",  elo: 1000 },
  { index: 4, img: "Desktop/Guyane/TORTUE.jpeg",  title: "üê¢ √âclosion de tortues ‚Äì Instant magique"   description: "Assiste √† l‚Äôun des plus beaux spectacles de la nature : des b√©b√©s tortues rejoignant l‚Äôoc√©an. C‚Äôest pur, fragile, √©mouvant. Un moment rare, qu‚Äôon n‚Äôoublie jamais.",  elo: 1000 },
  { index: 5, img: "Desktop/Guyane/savane.jpeg",  title: "ü™® Savane Roche ‚Äì Nuit en carbet & lever de soleil dans la jungle"   description: "Imagine-toi, berc√© par les sons de la for√™t, dormant en carbet, puis r√©veill√© par un lever de soleil irr√©el sur la canop√©e. Silence total. Juste toi, la nature, et une vue √† couper le souffle.",  elo: 1000 },
  { index: 6, img: "Guyane/petitsautmieux.jpeg",  title: "üåø Petit Saut ‚Äì Pirogue et Nuit dans la jungle"   description: "Pirogue, nuit en hamac, bruits de la for√™t, et immersion totale. Si tu veux "vivre la jungle", c‚Äôest ici que √ßa se passe. Authentique et sauvage. C'est ici que vous avez le plus de chance de voir tout les animaux ! P√™che, barbecue, observation !",  elo: 1000 },
  { index: 7, img: "Guyane/Petitsaut.jpeg",  title: "üö£‚Äç‚ôÄÔ∏è Petit Saut en KAYAK ‚Äì Journ√©e nature chill"   description: "Pagaye au fil de l‚Äôeau, entre criques calmes et jungle luxuriante. Une journ√©e tranquille, parfaite pour se reconnecter avec la nature‚Ä¶ mais version douce. (Sans nuit et moins d'animaux)",  elo: 1000 },
  { index: 8, img: "Guyane/Cacao.jpeg",  title: "ü•• Cacao ‚Äì Le charme Hmong en pleine for√™t"   description: "Direction le village de Cacao pour un march√© d√©paysant, une cuisine savoureuse et une d√©couverte touchante de la culture Hmong. Bonus : papillons g√©ants et artisanat √† tomber.",  elo: 1000 },
  { index: 9, img: "Guyane/Saul.jpeg", title: "üåÑ Sa√ºl ‚Äì 2/3 jours en lodge, paradis isol√©"  description: "Cap vers le bout du monde. √Ä Sa√ºl, pas de route, juste des sentiers, des cascades secr√®tes et une for√™t √† perte de vue. Lodge cosy, randos incroyables, puret√© absolue. Le vrai luxe, c‚Äôest l√†.", elo: 1000 }
];
// =============================================

// Variables globales
let playerName = "";
let currentPair = null;        // [indexA, indexB] indices dans "items" (pas Elo Index)
let remainingPairs = [];       // liste des paires √† comparer
let duelCount = 0;             // compteur de duels effectu√©s
let results = [];              // On stocke ici { winner, loser } pour l'envoi final

/**
 * Au chargement de la page, on r√©cup√®re les ELO actuels depuis la Sheet
 */
window.onload = () => {
  fetchCurrentRatings();
};

function fetchCurrentRatings() {
  fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      // data = { items: [ {index, title, rating}, ... ] }
      let sheetItems = data.items;
      // Mettre √† jour localement le Elo de nos 10 items
      // On matche par index
      sheetItems.forEach(si => {
        let local = items.find(x => x.index == si.index);
        if (local) {
          local.elo = si.rating;
        }
      });
      // Le user verra le startScreen
      document.getElementById("startScreen").classList.remove("hidden");
    })
    .catch(err => {
      alert("Erreur doGet : " + err);
    });
}

/**
 * L'utilisateur clique "Commencer"
 */
function startVoting() {
  let nameInput = document.getElementById("playerName");
  if (!nameInput.value) {
    alert("Merci d'entrer un nom !");
    return;
  }
  playerName = nameInput.value;

  // On masque l'√©cran de d√©marrage
  document.getElementById("startScreen").classList.add("hidden");
  // On g√©n√®re un set de NB_DUELS paires (al√©atoires)
  // Approche simple : on pioche au hasard dans toutes les paires (0..9, j>i)
  // On √©vite de tomber 2 fois sur la m√™me paire, √©videmment
  let allPairs = [];
  for (let i = 0; i < NB_ITEMS; i++) {
    for (let j = i+1; j < NB_ITEMS; j++) {
      allPairs.push([i,j]);
    }
  }
  shuffle(allPairs);
  // On prend les NB_DUELS premi√®res paires
  remainingPairs = allPairs.slice(0, NB_DUELS);

  duelCount = 0;
  results = [];

  document.getElementById("duelScreen").classList.remove("hidden");
  nextDuel();
}

function nextDuel() {
  if (remainingPairs.length === 0) {
    // Fini
    endVoting();
    return;
  }
  currentPair = remainingPairs.pop();
  duelCount++;

  let leftItem  = items[currentPair[0]];
  let rightItem = items[currentPair[1]];

  document.getElementById("leftImg").src      = leftItem.img;
  document.getElementById("leftTitle").innerText  = leftItem.title;

  document.getElementById("rightImg").src     = rightItem.img;
  document.getElementById("rightTitle").innerText = rightItem.title;

  document.getElementById("progress").innerText =
    `Duel ${duelCount} / ${NB_DUELS}`;
}

function choose(side) {
  let leftI  = currentPair[0];
  let rightI = currentPair[1];

  let winnerIndex = (side === "left") ? leftI : rightI;
  let loserIndex  = (side === "left") ? rightI : leftI;

  // On met √† jour *localement* l'Elo
  updateElo(winnerIndex, loserIndex);

  // On garde en m√©moire le r√©sultat pour doPost
  let winnerGlobalIndex = items[winnerIndex].index; // ex: 3
  let loserGlobalIndex  = items[loserIndex].index;  // ex: 5
  results.push({ winner: winnerGlobalIndex, loser: loserGlobalIndex });

  nextDuel();
}

/**
 * Calcul Elo local
 * (c'est optionnel : on le fait localement juste pour info,
 *  le vrai update final est re-fait dans doPost. Mais √ßa nous
 *  permet d'afficher un Elo final "coh√©rent" avant l'envoi.)
 */
function updateElo(idxW, idxL) {
  let ratingW = items[idxW].elo;
  let ratingL = items[idxL].elo;

  // Proba de victoire du winner
  let pW = 1 / (1 + Math.pow(10, (ratingL - ratingW) / 400));
  let pL = 1 - pW;

  let newW = ratingW + K_FACTOR * (1 - pW);
  let newL = ratingL + K_FACTOR * (0 - pL);

  items[idxW].elo = Math.round(newW);
  items[idxL].elo = Math.round(newL);
}

/**
 * Quand tous les duels sont finis, on envoie un doPost
 * { name, duels: [ {winner, loser}, ... ] }
 */
function endVoting() {
  document.getElementById("duelScreen").classList.add("hidden");
  
  let payload = {
    name: playerName,
    duels: results
  };

  fetch(SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    if (data.status === "success") {
      // data.items => le classement final
      displayFinalResults(data.items);
    } else {
      alert("Erreur doPost: " + data.message);
    }
  })
  .catch(err => {
    alert("Erreur doPost fetch : " + err);
  });
}

function displayFinalResults(finalItems) {
  // finalItems est d√©j√† tri√© par rating d√©croissant (voir doPost)
  let html = "";
  finalItems.forEach(it => {
    html += `<li>${it.title} (Elo: ${it.rating})</li>`;
  });
  document.getElementById("finalRanking").innerHTML = html;
  document.getElementById("resultsScreen").classList.remove("hidden");
}

/** M√©langer un tableau in-place */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
</script>

</body>
</html>
