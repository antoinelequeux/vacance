<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Votez pour les vacances</title>
  <!-- 1) Google Font : Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

  <!-- 2) Notre CSS -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #dfe9f3 0%, #ffffff 100%);
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #333;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    #startScreen, #duelScreen, #resultsScreen {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    
    .image-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .option {
      flex: 1 1 45%;
      text-align: center;
      margin: 10px;
    }
    
    img {
  width: 300px;
  height: 200px;
  object-fit: cover;
  border: 2px solid #ddd;
  border-radius: 8px;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
}

    
    .results li {
      margin-bottom: 5px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>

<h1>Votez pour les vacances</h1>

<!-- √âcran 1 : entrer nom + d√©marrer -->
<div id="startScreen">
  <p>Entrez votre nom : <input type="text" id="playerName" placeholder="Ex: Antoine le bg"></p>
  <button onclick="startVoting()">Commencer</button>
</div>

<!-- √âcran 2 : duels -->
<div id="duelScreen" class="hidden">
  <h2>Votez pour votre image pr√©f√©r√©e</h2>
  <p>Il y aura 20 duels.</p>
  
  <div id="duelContainer" class="image-container">
    <div class="option">
      <img id="leftImg" src="" alt="">
      <div id="leftTitle" style="font-weight: bold;"></div>
      <p id="leftDesc" style="font-style: italic;"></p>
      <button onclick="choose('left')">Choisir cette image</button>
    </div>
    <div class="option">
      <img id="rightImg" src="" alt="">
      <div id="rightTitle" style="font-weight: bold;"></div>
      <p id="rightDesc" style="font-style: italic;"></p>
      <button onclick="choose('right')">Choisir cette image</button>
    </div>
  </div>
  
  <p id="progress"></p>
</div>

<!-- √âcran 3 : r√©sultats finaux -->
<div id="resultsScreen" class="hidden">
  <h2>Merci, vos votes ont √©t√© pris en compte !</h2>
  <div class="results">
    <h3>Classement (Elo) √† jour</h3>
    <ol id="finalRanking"></ol>
  </div>
</div>

<script>
// ================== CONFIG ====================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyZ6ZvcFpIFkwcDgYiR_hiaD7v29ZtuA8IuXE0P1HOHcW8EP1W3vNfRyBTlvfCaqjQ/exec"; 
const NB_ITEMS = 10;  
const NB_DUELS = 20; // Nombre de duels par participant
const K_FACTOR = 32; // Le m√™me que dans Apps Script

// Tes 10 images (chemin, titre, description)
const items = [
  {
    index: 0,
    img: "Guyane/Kaw.jpeg",
    title: "üêä Kaw ‚Äì Journ√©e + nuit au Camp Ca√Øman",
    description: "Plonge au c≈ìur des marais de Kaw, entre ciel rose et brume myst√©rieuse. Croisi√®re au coucher du soleil, yeux qui brillent dans la nuit (coucou les ca√Ømans), et nuit magique au camp, en pleine nature (dans un lit). D√©connexion garantie.",
    elo: 1000
  },
  {
    index: 1,
    img: "Guyane/oiapoque.jpeg",
    title: "üéâ Oiapoque ‚Äì F√™te + nuit chez Rona",
    description: "Passe la fronti√®re pour une soir√©e br√©silienne comme tu les r√™ves : musique, danse, chaleur humaine. Et pour couronner le tout, nuit chez Rona, une ambiance locale, simple et authentique. T‚Äôen sortiras avec le sourire coll√© au visage.",
    elo: 1000
  },
  {
    index: 2,
    img: "Guyane/CSG.jpeg",
    title: "üöÄ Visite du CSG (Centre Spatial Guyanais)",
    description: "Explore le c≈ìur de l‚Äôaventure spatiale europ√©enne. Fus√©es, technologie de pointe, √©toiles plein les yeux. C‚Äôest pas tous les jours qu‚Äôon peut marcher l√† o√π Ariane d√©colle !",
    elo: 1000
  },
  {
    index: 3,
    img: "Guyane/iledusalut.jpeg",
    title: "üåä √éles du Salut ‚Äì Une journ√©e d‚Äô√©vasion historique",
    description: "Embarque pour une travers√©e vers les mythiques √éles du Salut. Plages paradisiaques, ruines charg√©es d‚Äôhistoire et singes curieux‚Ä¶ Le combo parfait entre d√©tente, aventure et frissons du pass√©.",
    elo: 1000
  },
  {
    index: 4,
    img: "Guyane/TORTUE.jpeg",
    title: "üê¢ √âclosion de tortues ‚Äì Instant magique",
    description: "Assiste √† l‚Äôun des plus beaux spectacles de la nature : des b√©b√©s tortues rejoignant l‚Äôoc√©an. C‚Äôest pur, fragile, √©mouvant. Un moment rare, qu‚Äôon n‚Äôoublie jamais.",
    elo: 1000
  },
  {
    index: 5,
    img: "Guyane/savane.jpeg",
    title: "ü™® Savane Roche ‚Äì Nuit en carbet & lever de soleil",
    description: "Imagine-toi, berc√© par les sons de la for√™t, dormant en carbet, puis r√©veill√© par un lever de soleil irr√©el sur la canop√©e. Silence total. Juste toi, la nature, et une vue √† couper le souffle.",
    elo: 1000
  },
  {
    index: 6,
    img: "Guyane/petitsautmieux.jpeg",
    title: "üåø Petit Saut ‚Äì Pirogue et Nuit dans la jungle",
    description: "Pirogue, nuit en hamac, bruits de la for√™t, et immersion totale. Si tu veux vivre la jungle, c‚Äôest ici que √ßa se passe. Authentique et sauvage. C'est ici que vous avez le plus de chance de voir tout les animaux ! P√™che, barbecue, observation !",
    elo: 1000
  },
  {
    index: 7,
    img: "Guyane/Petitsaut.jpeg",
    title: "üö£‚Äç‚ôÄÔ∏è Petit Saut en KAYAK ‚Äì Journ√©e nature chill",
    description: "Pagaye au fil de l‚Äôeau, entre criques calmes et jungle luxuriante. Une journ√©e tranquille, parfaite pour se reconnecter avec la nature‚Ä¶ mais version douce. (Sans nuit et moins d'animaux)",
    elo: 1000
  },
  {
    index: 8,
    img: "Guyane/Cacao.jpeg",
    title: "ü•• Cacao ‚Äì Le charme Hmong en pleine for√™t",
    description: "Direction le village de Cacao pour un march√© d√©paysant, une cuisine savoureuse et une d√©couverte touchante de la culture Hmong. Bonus : papillons g√©ants et artisanat √† tomber.",
    elo: 1000
  },
  {
    index: 9,
    img: "Guyane/Saul.jpeg",
    title: "üåÑ Sa√ºl ‚Äì 2/3 jours en lodge, paradis isol√©",
    description: "Cap vers le bout du monde. √Ä Sa√ºl, pas de route, juste des sentiers, des cascades secr√®tes et une for√™t √† perte de vue. Lodge cosy, randos incroyables, puret√© absolue. Le vrai luxe, c‚Äôest l√†.",
    elo: 1000
  },
];
// =============================================

// Variables globales
let playerName = "";
let currentPair = null;        
let remainingPairs = [];
let duelCount = 0;
let results = [];

// AJOUT ICI
let votingEnded = false;


/**
 * Au chargement de la page, on r√©cup√®re les ELO actuels depuis la Sheet
 */
window.onload = () => {
  fetchCurrentRatings();
};

function fetchCurrentRatings() {
  fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      // data = { items: [ {index, title, rating}, ... ] }
      let sheetItems = data.items;
      // Mettre √† jour localement le Elo de nos 10 items
      sheetItems.forEach(si => {
        let local = items.find(x => x.index == si.index);
        if (local) {
          local.elo = si.rating;
        }
      });
      document.getElementById("startScreen").classList.remove("hidden");
    })
    .catch(err => {
      alert("Erreur doGet : " + err);
    });
}

/**
 * L'utilisateur clique "Commencer"
 */
function startVoting() {
  let nameInput = document.getElementById("playerName");
  if (!nameInput.value) {
    alert("Merci d'entrer un nom connard !");
    return;
  }
  playerName = nameInput.value;

  document.getElementById("startScreen").classList.add("hidden");

// === SMART BALANCED SAMPLING : chaque item doit appara√Ætre au moins une fois ===

let allPairs = [];
for (let i = 0; i < NB_ITEMS; i++) {
  for (let j = i + 1; j < NB_ITEMS; j++) {
    allPairs.push([i, j]);
  }
}

// M√©langer al√©atoirement les 45 paires
shuffle(allPairs);

// Suivi des apparitions par item
let freqMap = new Array(NB_ITEMS).fill(0);
remainingPairs = [];
let usedPairs = new Set();

// Fonction pour g√©n√©rer une cl√© unique pour une paire
const pairKey = (a, b) => [Math.min(a, b), Math.max(a, b)].join("-");

// √âtape 1 : s'assurer que chaque item apparaisse au moins une fois
let covered = new Set();
for (let i = 0; i < allPairs.length && covered.size < NB_ITEMS; i++) {
  let [a, b] = allPairs[i];
  if (!covered.has(a) || !covered.has(b)) {
    let key = pairKey(a, b);
    if (!usedPairs.has(key)) {
      remainingPairs.push([a, b]);
      usedPairs.add(key);
      freqMap[a]++;
      freqMap[b]++;
      covered.add(a);
      covered.add(b);
    }
  }
}

// √âtape 2 : compl√©ter jusqu'√† 20 duels avec contrainte de max apparitions
let maxAllowed = 5;
for (let i = 0; i < allPairs.length && remainingPairs.length < NB_DUELS; i++) {
  let [a, b] = allPairs[i];
  let key = pairKey(a, b);

  if (usedPairs.has(key)) continue;

  if (freqMap[a] < maxAllowed && freqMap[b] < maxAllowed) {
    remainingPairs.push([a, b]);
    usedPairs.add(key);
    freqMap[a]++;
    freqMap[b]++;
  }
}

// Optionnel : log du nombre d‚Äôapparitions par item
console.log("Fr√©quences finales :");
items.forEach((item, i) => {
  console.log(`${item.title} ‚Üí ${freqMap[i]} apparitions`);
});






// Tu peux mettre √† jour freqMap ici si tu veux l'utiliser plus loin

  duelCount = 0;
  results = [];

  document.getElementById("duelScreen").classList.remove("hidden");
  nextDuel();
}

function nextDuel() {
  if (remainingPairs.length === 0) {
    // Fini
    endVoting();
    return;
  }
  currentPair = remainingPairs.pop();
  duelCount++;

  let leftItem  = items[currentPair[0]];
  let rightItem = items[currentPair[1]];

  // Remplir l'image, titre et description c√¥t√© gauche
  document.getElementById("leftImg").src = leftItem.img;
  document.getElementById("leftTitle").innerText = leftItem.title;
  document.getElementById("leftDesc").innerText  = leftItem.description;

  // Remplir l'image, titre et description c√¥t√© droit
  document.getElementById("rightImg").src = rightItem.img;
  document.getElementById("rightTitle").innerText = rightItem.title;
  document.getElementById("rightDesc").innerText = rightItem.description;

  // Indiquer la progression
  document.getElementById("progress").innerText =
    `Duel ${duelCount} / ${NB_DUELS}`;
}

function choose(side) {
  // AJOUT
  if (votingEnded) {
    // Si on a d√©j√† fini, on ignore ce clic
    return;
  }
  let leftI  = currentPair[0];
  let rightI = currentPair[1];

  let winnerIndex = (side === "left") ? leftI : rightI;
  let loserIndex  = (side === "left") ? rightI : leftI;

  // On met √† jour *localement* l'Elo
  updateElo(winnerIndex, loserIndex);

  // On garde en m√©moire le r√©sultat pour doPost
  let winnerGlobalIndex = items[winnerIndex].index; 
  let loserGlobalIndex  = items[loserIndex].index;  
  results.push({ winner: winnerGlobalIndex, loser: loserGlobalIndex });

  nextDuel();
}

/**
 * Calcul Elo local (optionnel)
 * On le fait pour afficher les Elo persos, 
 * mais le vrai update se fera dans Apps Script via doPost.
 */
function updateElo(idxW, idxL) {
  let ratingW = items[idxW].elo;
  let ratingL = items[idxL].elo;

  // Proba de victoire du winner
  let pW = 1 / (1 + Math.pow(10, (ratingL - ratingW) / 400));
  let pL = 1 - pW;

  let newW = ratingW + K_FACTOR * (1 - pW);
  let newL = ratingL + K_FACTOR * (0 - pL);

  items[idxW].elo = Math.round(newW);
  items[idxL].elo = Math.round(newL);
}

/**
 * Quand tous les duels sont finis, on envoie un doPost
 * { name, duels: [ {winner, loser}, ... ] }
 */
function endVoting() {
  // AJOUT LIGNE
  votingEnded = true;
    document.getElementById("duelScreen").classList.add("hidden");
  const formData = new URLSearchParams();
  formData.append("name", playerName);
  formData.append("duels", JSON.stringify(results));

  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === "success") {
      displayFinalResults(data.items, data.participants);
    } else {
      alert("Erreur doPost: " + data.message);
    }
  })
  .catch(err => {
    alert("Erreur doPost fetch : " + err);
  });
}



function displayFinalResults(finalItems, participants) {
  let html = "<h3>Classement global (Elo)</h3><ol>";
  finalItems.forEach(it => {
    html += `<li>${it.title} (Elo: ${it.rating})</li>`;
  });
  html += "</ol>";

  html += "<h3>Classement perso de chaque participant</h3>";

participants.forEach(p => {
  html += `<h4>${p.name}</h4>`;
  html += `<table style="margin:auto; border-collapse: collapse;">`;
  html += `<tr><th style="border-bottom: 1px solid #ccc; padding: 5px;">Destination</th><th style="border-bottom: 1px solid #ccc; padding: 5px;">Score</th></tr>`;

  let rankingArray = p.personalRanking.split(", ").map(entry => {
    let match = entry.match(/(.+)\((\d+)\)$/);
    if (match) {
      return { title: match[1], score: parseInt(match[2]) };
    } else {
      return null;
    }
  }).filter(x => x !== null);

  rankingArray.forEach(entry => {
    html += `<tr>
      <td style="padding: 5px; border-bottom: 1px solid #eee;">${entry.title}</td>
      <td style="padding: 5px; border-bottom: 1px solid #eee; text-align:center;">${entry.score}</td>
    </tr>`;
  });

  html += `</table><br>`;
});


  document.getElementById("finalRanking").innerHTML = html;
  document.getElementById("resultsScreen").classList.remove("hidden");
}


/** M√©langer un tableau in-place */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
</script>

</body>
</html>
